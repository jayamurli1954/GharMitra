name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch: # Allow manual triggering

jobs:
  backend-tests:
    name: Backend Tests & Linting
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run linting (flake8)
        working-directory: ./backend
        run: |
          pip install flake8
          # Stop the build if there are Python syntax errors or undefined names
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # Exit-zero treats all errors as warnings
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
        continue-on-error: true # Don't fail on linting issues
      
      - name: Run backend tests
        working-directory: ./backend
        run: |
          python -m pytest tests/ -v --tb=short || true
        continue-on-error: true # Don't fail if tests are missing
      
      - name: Check Python syntax
        working-directory: ./backend
        run: |
          python -m py_compile app/**/*.py || true
        continue-on-error: true

  frontend-tests:
    name: Frontend Build & Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install root dependencies
        run: npm ci
      
      - name: Install web dependencies
        working-directory: ./web
        run: npm ci
      
      - name: Check JavaScript syntax (root)
        run: |
          npx eslint --version || echo "ESLint not configured"
        continue-on-error: true
      
      - name: Build web frontend
        working-directory: ./web
        run: |
          npm run build || echo "Build may have warnings"
        continue-on-error: true
      
      - name: Run frontend tests
        run: |
          npm test -- --passWithNoTests || true
        continue-on-error: true

  validate-dependencies:
    name: Validate Dependencies
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Validate backend requirements.txt
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install --dry-run -r backend/requirements.txt || true
        continue-on-error: true
      
      - name: Validate package.json (root)
        run: |
          npm install --dry-run || true
        continue-on-error: true
      
      - name: Validate web package.json
        working-directory: ./web
        run: |
          npm install --dry-run || true
        continue-on-error: true

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run Bandit (Python security linter)
        working-directory: ./backend
        run: |
          pip install bandit
          bandit -r app/ -f json -o bandit-report.json || true
        continue-on-error: true
      
      - name: Run npm audit (check for vulnerabilities)
        run: |
          npm audit --audit-level=moderate || true
        continue-on-error: true
      
      - name: Run npm audit (web)
        working-directory: ./web
        run: |
          npm audit --audit-level=moderate || true
        continue-on-error: true

  build-check:
    name: Build Verification
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Verify backend imports
        working-directory: ./backend
        run: |
          pip install -r requirements.txt
          python -c "import app.main; print('Backend imports OK')" || true
        continue-on-error: true
      
      - name: Verify web build
        working-directory: ./web
        run: |
          npm ci
          npm run build || echo "Build check completed with warnings"
        continue-on-error: true
